<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>S√§hk√∂miehen erikoispeli</title>
  <style>
    html, body {
      margin: 0;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      width: 100vw;
      height: calc(var(--vh, 1vh) * 100);
      box-sizing: border-box;
      overflow: hidden;
      background: #111827;
      font-family: Arial, sans-serif;
    }
    #canvasContainer {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #000;
    }
    #canvasFrame {
      width: min(414px, 100%);
      aspect-ratio: 414 / 896;
      border: 16px solid #333;
      border-radius: 50px;
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
      position: relative;
      overflow: hidden;
      background: #111827;
    }
    #canvasFrame canvas {
      width: 100%;
      height: 100%;
      display: block;
      touch-action: none;
      cursor: pointer;
    }
    #ui-panel {
      position: absolute;
      top: calc(env(safe-area-inset-top) + 1rem);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.2);
      color: #fff;
      padding: .75rem 1.5rem;
      border-radius: 1rem;
      box-shadow: 0 8px 16px rgba(0,0,0,0.4);
      display: flex;
      gap: 1rem;
      font-weight: 600;
      z-index: 10;
      backdrop-filter: blur(10px);
    }
    #startOverlay,
    #notificationOverlay,
    #shockOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      z-index: 100;
      color: #fff;
      text-align: center;
      padding: 1rem;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    #startOverlay h1 { font-size: 2rem; margin-bottom: 1rem; }
    #startOverlay p  { color: #ccc; margin-bottom: 2rem; max-width: 90%; }
    button {
      background: #10b981;
      color: #fff;
      border: none;
      border-radius: .5rem;
      padding: 1rem 2rem;
      font-size: 1.25rem;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    button:hover { background: #059669; }
    #notificationOverlay p { font-size: 1.5rem; margin-bottom: 1rem; }
    #groundLogo {
      position: absolute;
      left: 50%;
      bottom: calc(env(safe-area-inset-bottom) + 4rem);
      transform: translateX(-50%);
      width: 40px;
      height: 40px;
      background: white;
      border-radius: 50%;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
      z-index: 5;
    }
    #groundLogo::before {
      content: '';
      position: absolute;
      top: 0;
      left: -10px;
      width: 60px;
      height: 60px;
      background: repeating-linear-gradient(45deg, yellow 0, yellow 10px, lime 10px, lime 20px);
    }
    #groundLogo::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 12px;
      height: 12px;
      background: #b87333;
      border-radius: 50%;
      box-shadow: 0 1px 3px rgba(0,0,0,0.4);
    }
  </style>
</head>
<body>
  <div id="startOverlay">
    <h1>S√§hk√∂miehen erikoispeli</h1>
    <p>Yhdist√§ samanv√§riset kaapelit. Jos paria ei l√∂ydy, ved√§ kaapeli MAA-alueelle.</p>
    <button id="startBtn">Aloita peli</button>
  </div>
  <div id="canvasContainer">
    <div id="canvasFrame">
      <canvas id="gameCanvas"></canvas>
      <div id="groundLogo"></div>
      <div id="shockOverlay"></div>
      <div id="notificationOverlay">
        <p id="notifyText">Sait 0 pistett√§ ajassa 00:00</p>
        <button id="notifyRestartBtn">Aloita uusi peli</button>
      </div>
      <div id="ui-panel">
        <div>ü™ô <span id="score">0</span></div>
        <div>‚è±Ô∏è <span id="elapsed">00:00</span></div>
      </div>
      <button id="restartBtn" style="display:none;">Aloita uusi peli</button>
    </div>
  </div>
  <script type="module">
    import { formatTime, generateWires } from './gameUtils.js';
    function updateVh() {
      document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
    }
    window.addEventListener('resize', updateVh);
    updateVh();

    document.addEventListener('DOMContentLoaded', () => {
      const frame = document.getElementById('canvasFrame');
      const canvas = document.getElementById('gameCanvas');
      const ctx = canvas.getContext('2d');
      const startOverlay = document.getElementById('startOverlay');
      const startBtn = document.getElementById('startBtn');
      const restartBtn = document.getElementById('restartBtn');
      const shockOverlay = document.getElementById('shockOverlay');
      const notifyOverlay = document.getElementById('notificationOverlay');
      const notifyText = document.getElementById('notifyText');
      const notifyRestartBtn = document.getElementById('notifyRestartBtn');
      const scoreEl = document.getElementById('score');
      const elapsedEl = document.getElementById('elapsed');
      const colors = ['red','blue','green','yellow','orange','purple','cyan','lime','maa'];

      let score = 0;
      let maxScore = parseInt(localStorage.getItem('maxScore') || '0', 10);
      let elapsedTime = 0;
      let elapsedInterval;
      let wires = [];
      let dragging = false;
      let startWire = null;
      let currPos = { x: 0, y: 0 };
      const wireRadius = 20;

      function hideStart() {
        startOverlay.style.display = 'none';
        startGame();
      }
      function resizeCanvas() {
        canvas.width = frame.clientWidth;
        canvas.height = frame.clientHeight;
      }
      function startTimer() {
        elapsedTime = 0;
        elapsedEl.textContent = formatTime(0);
        clearInterval(elapsedInterval);
        elapsedInterval = setInterval(() => {
          elapsedTime++;
          elapsedEl.textContent = formatTime(elapsedTime);
        }, 1000);
      }
      function stopTimer() {
        clearInterval(elapsedInterval);
      }
      function updateScore(v) {
        score += v;
        scoreEl.textContent = score;
        if (score > maxScore) {
          maxScore = score;
          localStorage.setItem('maxScore', maxScore);
        }
      }
      function drawWire(x,y,c) {
        ctx.beginPath(); ctx.fillStyle='white'; ctx.arc(x,y,wireRadius,0,2*Math.PI); ctx.fill();
        ctx.save(); ctx.translate(x,y); ctx.rotate(25*Math.PI/180);
        ctx.fillStyle='rgba(255,255,255,0.5)'; ctx.fillRect(-wireRadius,-5,wireRadius*2,10); ctx.restore();
        ctx.beginPath(); ctx.fillStyle=c; ctx.arc(x,y,wireRadius*0.75,0,2*Math.PI); ctx.fill();
        ctx.save(); ctx.shadowColor='rgba(0,0,0,0.4)'; ctx.shadowBlur=4;
        ctx.beginPath(); ctx.fillStyle='#b87333'; ctx.arc(x,y,wireRadius*0.2,0,2*Math.PI); ctx.fill(); ctx.restore();
      }
      function draw() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        wires.forEach(w => drawWire(w.x, w.y, w.color));
        if (dragging && startWire) {
          ctx.beginPath(); ctx.moveTo(startWire.x, startWire.y);
          ctx.lineTo(currPos.x, currPos.y); ctx.strokeStyle='#b87333'; ctx.lineWidth=5; ctx.stroke();
        }
      }
      function startGame() {
        resizeCanvas();
        score=0; scoreEl.textContent='0';
        startTimer();
        wires = generateWires(canvas.width, canvas.height, colors);
        draw();
        restartBtn.style.display='none'; notifyOverlay.style.display='none'; shockOverlay.style.display='none';
      }
      function getPt(e) {
        const r = canvas.getBoundingClientRect();
        const t = (e.touches && e.touches[0]) || (e.changedTouches && e.changedTouches[0]) || e;
        return { x: t.clientX - r.left, y: t.clientY - r.top };
      }
      function handleEnd(pt) {
        if (!startWire) return;
        const tgt = wires.find(w => w!==startWire && Math.hypot(w.x-pt.x,w.y-pt.y)<wireRadius);
        if (tgt && tgt.color===startWire.color) {
          wires = wires.filter(w => w!==startWire && w!==tgt);
          updateScore(10);
        } else if (Math.hypot(pt.x-canvas.width/2, pt.y-(canvas.height-60))<30 &&
                   (startWire.color==='maa' || wires.filter(w => w.color===startWire.color).length===0)) {
          wires = wires.filter(w => w!==startWire);
          updateScore(10);
        } else {
          stopTimer(); shockOverlay.style.display='flex';
          setTimeout(() => {
            shockOverlay.style.display='none';
            notifyText.textContent=`Hupsista! Ota huikka! Sait ${score} pistett√§ ajassa ${formatTime(elapsedTime)}`;
            notifyOverlay.style.display='flex';
          },300);
          dragging=false; startWire=null; draw(); return;
        }
          if (wires.length===0) {
            setTimeout(() => {
              wires = generateWires(canvas.width, canvas.height, colors);
              draw();
            }, 500);
          } else {
            draw();
          }
        dragging=false; startWire=null;
      }
      window.addEventListener('resize', () => {
        resizeCanvas();
        draw();
      });
      startBtn.addEventListener('click', hideStart);
      restartBtn.addEventListener('click', startGame);
      notifyRestartBtn.addEventListener('click', startGame);
      canvas.addEventListener('touchstart', e => { currPos=getPt(e); startWire=wires.find(w => Math.hypot(w.x-currPos.x,w.y-currPos.y)<wireRadius); dragging=!!startWire; });
      canvas.addEventListener('touchmove', e => { if (!dragging) return; currPos=getPt(e); draw(); });
      canvas.addEventListener('touchend', e => { currPos=getPt(e); handleEnd(currPos); });
      canvas.addEventListener('mousedown', e => { currPos=getPt(e); startWire=wires.find(w => Math.hypot(w.x-currPos.x,w.y-currPos.y)<wireRadius); dragging=!!startWire; });
      canvas.addEventListener('mousemove', e => { if (!dragging) return; currPos=getPt(e); draw(); });
      canvas.addEventListener('mouseup', e => { currPos=getPt(e); handleEnd(currPos); });
      startOverlay.style.display='flex';
    });
  </script>
</body>
</html>
